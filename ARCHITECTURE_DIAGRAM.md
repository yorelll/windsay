# Cloudflare Pages 部署架构图

## 整体架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           Hexo 博客部署架构                               │
└─────────────────────────────────────────────────────────────────────────┘

                                本地开发环境
                    ┌──────────────────────────────┐
                    │    开发者电脑                  │
                    │  ┌────────────────────┐      │
                    │  │  my-hexo-blog/     │      │
                    │  │  ├── source/       │      │
                    │  │  ├── themes/       │      │
                    │  │  │   └── windsay/  │      │
                    │  │  └── _config.yml   │      │
                    │  └────────────────────┘      │
                    │          │                    │
                    │          │ hexo new post      │
                    │          │ hexo server        │
                    │          ▼                    │
                    │    http://localhost:4000     │
                    └──────────────┬───────────────┘
                                   │
                                   │ git add/commit/push
                                   ▼
                    ┌──────────────────────────────┐
                    │         GitHub                │
                    │  ┌────────────────────┐      │
                    │  │  博客仓库           │      │
                    │  │  (your-repo)       │      │
                    │  │  ├── main 分支     │      │
                    │  │  └── 子模块:       │      │
                    │  │      windsay       │      │
                    │  └────────┬───────────┘      │
                    │           │                   │
                    │           │ 触发工作流         │
                    │           ▼                   │
                    │  ┌────────────────────┐      │
                    │  │  GitHub Actions    │      │
                    │  │  ├── Checkout      │      │
                    │  │  ├── Setup Node.js │      │
                    │  │  ├── npm install   │      │
                    │  │  ├── hexo generate │      │
                    │  │  └── 部署到 CF     │      │
                    │  └────────┬───────────┘      │
                    └───────────┼───────────────────┘
                                │
                                │ API 调用
                                ▼
                    ┌──────────────────────────────┐
                    │       Cloudflare Pages        │
                    │  ┌────────────────────┐      │
                    │  │  项目: windsay-blog│      │
                    │  │  ├── 接收构建产物   │      │
                    │  │  ├── 部署到 CDN    │      │
                    │  │  ├── 生成 SSL 证书 │      │
                    │  │  └── 配置域名      │      │
                    │  └────────┬───────────┘      │
                    │           │                   │
                    │           │ 全球 CDN 分发     │
                    │           ▼                   │
                    │  https://blog.windsay.qzz.io │
                    └──────────────────────────────┘
                                │
                                │
                                ▼
                    ┌──────────────────────────────┐
                    │         访客浏览器             │
                    │  全球任何地方的用户都能快速访问  │
                    └──────────────────────────────┘
```

## 工作流详细步骤

```
┌─────────────────────────────────────────────────────────────────┐
│                    GitHub Actions 工作流                          │
└─────────────────────────────────────────────────────────────────┘

    触发: git push to main
         │
         ▼
    ┌─────────────────────┐
    │ 1. Checkout代码      │
    │    包括子模块        │
    └──────────┬──────────┘
               │
               ▼
    ┌─────────────────────┐
    │ 2. Setup Node.js 18  │
    │    配置 npm 缓存     │
    └──────────┬──────────┘
               │
               ▼
    ┌─────────────────────┐
    │ 3. 安装依赖          │
    │    npm ci           │
    └──────────┬──────────┘
               │
               ▼
    ┌─────────────────────┐
    │ 4. 构建网站          │
    │    hexo clean       │
    │    hexo generate    │
    └──────────┬──────────┘
               │
               ▼
    ┌─────────────────────┐
    │ 5. 部署到 Cloudflare │
    │    使用 API Token   │
    │    推送 public/ 目录 │
    └──────────┬──────────┘
               │
               ▼
         部署成功！
    https://blog.windsay.qzz.io
```

## 数据流向

```
┌──────────────────────────────────────────────────────────────┐
│                        数据流向图                              │
└──────────────────────────────────────────────────────────────┘

Markdown 文章
    │
    │ hexo generate
    ▼
静态 HTML/CSS/JS
    │
    │ git push
    ▼
GitHub 仓库
    │
    │ GitHub Actions
    ▼
构建产物 (public/)
    │
    │ Cloudflare API
    ▼
Cloudflare Pages
    │
    │ CDN 分发
    ▼
全球边缘节点
    │
    │ HTTPS
    ▼
用户浏览器
```

## 主题管理

```
┌──────────────────────────────────────────────────────────────┐
│                      主题仓库关系图                            │
└──────────────────────────────────────────────────────────────┘

主题仓库 (yorelll/windsay)
    │
    │ 作为 Git 子模块
    ▼
博客仓库 (your-username/my-hexo-blog)
    │
    ├── themes/windsay/  ←── 子模块引用
    ├── source/
    └── _config.yml


更新主题:
    git submodule update --remote themes/windsay
    git add themes/windsay
    git commit -m "更新主题"
    git push
```

## 域名解析

```
┌──────────────────────────────────────────────────────────────┐
│                       DNS 解析流程                             │
└──────────────────────────────────────────────────────────────┘

用户输入: blog.windsay.qzz.io
    │
    ▼
Cloudflare DNS
    │
    ├─ A 记录或 CNAME
    │  指向 Cloudflare Pages
    │
    ▼
Cloudflare Pages
    │
    ├─ SSL/TLS 加密
    │
    ▼
返回网站内容
```

## 缓存策略

```
┌──────────────────────────────────────────────────────────────┐
│                     Cloudflare 缓存策略                        │
└──────────────────────────────────────────────────────────────┘

静态资源
├── HTML 文件
│   └── 缓存时间: 短 (1小时)
│       原因: 内容更新频繁
│
├── CSS/JS 文件
│   └── 缓存时间: 长 (1年)
│       原因: 文件名包含 hash
│
└── 图片文件
    └── 缓存时间: 长 (1年)
        原因: 内容不变

CDN 边缘节点
├── 美洲
├── 欧洲
├── 亚洲
└── 大洋洲
    └── 每个节点都缓存内容
        用户访问最近的节点
```

## 安全架构

```
┌──────────────────────────────────────────────────────────────┐
│                        安全层级                                │
└──────────────────────────────────────────────────────────────┘

GitHub Secrets
├── CLOUDFLARE_API_TOKEN  (加密存储)
└── CLOUDFLARE_ACCOUNT_ID (加密存储)
    │
    │ 仅在 Actions 运行时可用
    ▼
GitHub Actions
    │
    │ TLS 加密传输
    ▼
Cloudflare API
    │
    │ 权限验证
    ▼
Cloudflare Pages
    │
    │ 自动 HTTPS
    │ DDoS 防护
    │ WAF 防火墙
    ▼
最终用户
```

## 成本结构

```
┌──────────────────────────────────────────────────────────────┐
│                        成本分析                                │
└──────────────────────────────────────────────────────────────┘

GitHub
├── 仓库托管: 免费
├── Actions: 免费 (公开仓库)
└── 存储: 无限 (代码)

Cloudflare Pages
├── 托管: 免费
├── 构建次数: 无限
├── 流量: 无限
├── CDN: 免费
└── SSL: 免费

域名
└── blog.windsay.qzz.io
    └── 已有域名，无额外成本

总成本: 0 元/月 💰
```

## 性能指标

```
┌──────────────────────────────────────────────────────────────┐
│                       性能指标                                 │
└──────────────────────────────────────────────────────────────┘

构建速度
├── 首次构建: 3-5 分钟
└── 增量构建: 2-3 分钟

部署速度
├── 上传: < 1 分钟
└── CDN 分发: < 1 分钟

访问速度
├── 首次访问: < 500ms (全球平均)
├── 二次访问: < 100ms (CDN 缓存)
└── TTI (可交互时间): < 2s

可靠性
├── SLA: 99.99%
└── CDN 节点: 275+ 全球
```

## 图例说明

```
符号说明:
│  ├  └  ┌  ┐  ┘  ─  ▼  ▲  →  ←  表示流程和关系
✅  表示验证通过
❌  表示失败或错误
⚠️  表示警告
💰  表示成本
🚀  表示部署
📦  表示构建产物
🔒  表示安全/加密
```
